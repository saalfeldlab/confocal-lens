import ij.*;
import ij.gui.PolygonRoi;
import ij.gui.Roi;
import ij.process.*;
import java.awt.Color;
import java.awt.Font;
import java.awt.geom.AffineTransform;
import java.util.*;
import mpicbg.trakem2.transform.*;
import mpicbg.ij.util.*;
import mpicbg.models.Model;
import mpicbg.models.IdentityModel;
import mpicbg.models.Point;
import mpicbg.models.PointMatch;

int w = 256;
int h = 256;
double max = 5;
int pWidth = 1024;
int pHeight = 1024;

int ySkip = 4;
int xSkip = 4;

invarianceModelClass = IdentityModel.class;
//invarianceModelClass = RigidModel2D.class;
//invarianceModelClass = AffineModel2D.class;

transforms = new String[][]
{
	{
		"Identity",
		"mpicbg.trakem2.transform.AffineModel2D",
		"1.0 0.0 0.0 1.0 0.0 0.0"
	},
	{
		"scope 5, 488 bead sample 3 1",
		"mpicbg.trakem2.transform.NonLinearCoordinateTransform",
		"5 21 271.8127572200841 -3.2785869707254602 -4.134667816495836 251.31852942524065 25.048759451456966 -23.694120289734037 8.179228211713962 16.609458525465335 7.279157656352389 21.65489926463879 -52.40319916225238 78.25447822260475 -4.491150953097175 -17.166600423243388 -9.68769226539715 -3.6232649025872563 -7.848302074513312 -24.764691858867984 57.196485927753294 -81.53529516968777 1.77031619588758 4.9697258502568395 4.763877654271459 3.5538109029197935 3.8986272723817734 1.423774474100315 6.622209412503789 16.235796932837648 -24.30338946798166 30.875147541092005 0.5342237100121225 -2.582953203063103 -2.469138040918274 0.5153878604268678 -0.17995231162775915 -2.706312195818361 -1.8275456837135506 0.9035716559167055 -1.9455095936354563 -6.572089214172378 5.807093662840247 3.8060751705324267 580.7110341853044 380.60532610218036 414907.0100602755 229933.92960540653 213311.68558457217 3.239385128107301E8 1.6734124902513266E8 1.3291345461794916E8 1.4413269807768196E8 2.663010232151769E11 1.3197797062208156E11 9.801295898313295E10 9.180033886565125E10 1.0868462307641757E11 2.265167870450514E14 1.0914299489247661E14 7.783995926149283E13 6.830843773063399E13 7.023673927815905E13 8.792931535779356E13 100.0 278.71841019217743 261.6357231603346 306848.3666003312 212472.71119773903 251365.42275471537 3.0407104548853046E8 1.91385896198953E8 1.8684962693932888E8 2.3188162219395384E8 2.94373086044422E11 1.7594014269529083E11 1.5967292295884827E11 1.684758358466133E11 2.157819187415687E11 2.833861140300086E14 1.637763799994757E14 1.4253213212845603E14 1.4157402871470572E14 1.5523899210242678E14 2.0276957281428506E14 0.0 1024 1024 ",
		"mpicbg.trakem2.transform.AffineModel2D",
		"0.9932298035093786 -0.005779014422213595 -0.004330907007843785 0.9545278461416745 7.177169082131808 26.457274692220864"
	},
	{
		"scope 5, 488 bead sample 3 2",
		"lenscorrection.NonLinearTransform",
		"5 21 271.37125121079015 -3.760374599280545 -3.7638269940623776 249.0953716466072 27.8523111750401 -21.381722399061378 7.774896649858991 16.789978400152634 5.416616066819875 22.779694161912385 -58.84448234273439 73.66237066197367 -4.514934172942598 -17.76324229515252 -8.679695084844518 -3.8610202975368764 -3.7276275310827263 -27.4264829661632 63.44383816824306 -77.32483130551424 2.039617220042281 5.797207065860109 4.338351644296711 3.220971768859772 3.1652805670178887 2.2852546430213065 2.449253092140303 18.664423893965214 -26.51123744307926 29.382828024307045 0.529052433712538 -2.7401351698571377 -2.656199331222694 0.2201312284258949 0.20809088886433225 -2.274461380035174 -1.7159719581830326 0.2607185071690816 -0.39594144516811447 -7.299419124409635 5.798919711435706 3.8162811741599607 579.8936648600949 381.62608170458157 413932.8278754497 229775.04042656097 213009.6255925724 3.228807629764268E8 1.6691490110831994E8 1.3235623146254349E8 1.4308827799081516E8 2.6521766549397678E11 1.3144449657879504E11 9.74617016203694E10 9.102740392879706E10 1.0727187200052252E11 2.2543257808883866E14 1.0856263349289328E14 7.730617739716994E13 6.7693051479165234E13 6.935965289048392E13 8.634084454412E13 100.0 278.67258145464547 259.563296133238 306398.4174407058 211344.32124930652 248798.2289612365 3.034187789374859E8 1.904024027326021E8 1.8552247798950496E8 2.2891797413897628E8 2.93502782327027E11 1.7490136802805627E11 1.5857043882024966E11 1.6698502757509262E11 2.125461727332552E11 2.822726905307268E14 1.6259454085841078E14 1.4142008163182606E14 1.4039576120697483E14 1.5364628784924194E14 1.9933811888118353E14 0.0 1024 1024 ",
		"mpicbg.trakem2.transform.AffineModel2D",
		"0.9931277526681077 -0.005808310577117364 -0.004364373844072198 0.9544456123548117 7.241303896625714 26.02219947730343"
	},
	{
		"scope 5, 561 bead sample 3",
		"lenscorrection.NonLinearTransform",
		"5 21 268.47347800096577 -4.244966467578929 -3.580133632242684 245.71973453853357 7.2878939042338775 -18.818534992930733 7.2853667346886235 15.535879676319448 4.609789044505732 24.708508644989813 19.544769842258823 69.142138144147 -4.207627036765254 -14.432889039582745 -7.039796415182282 -2.981738541196828 -2.9044040209816195 -31.30698298439524 -31.457760737959816 -73.88178610810326 2.2406121818757683 2.2958117896207675 4.104308112405354 1.5410951707648526 0.8316515415901122 2.5597461617045107 2.624073040918276 21.997429141933782 10.609414718690942 28.358839257086128 0.07317590583226163 -1.2062630647730197 -2.1601416333313166 0.4034558652847159 -0.11231679624607316 -1.5362450994924908 -0.558502483513271 -0.2713213479660749 -0.7603107095403967 -8.29354115590069 5.766433203196762 3.799800802233901 576.6442326104516 379.9783447613863 408697.787820044 228564.47287507993 210194.8028291792 3.165139811860504E8 1.6556568530274183E8 1.307675656362256E8 1.3987504742811406E8 2.5826933862525458E11 1.2990917249772696E11 9.627709418144241E10 8.92418299474961E10 1.0394762239010014E11 2.1818608233048028E14 1.0690342840402083E14 7.626893283629511E13 6.651964867214126E13 6.751817933997118E13 8.299313257869005E13 100.0 276.0115475374366 256.5423710742451 302058.3362201714 209850.42565046102 244475.44761902394 2.9788127969270104E8 1.8904118339079216E8 1.8355425035760158E8 2.2355243501207876E8 2.868331260330541E11 1.734625322777028E11 1.5742381870092142E11 1.6470744024875684E11 2.0642925327221323E11 2.7462042177592E14 1.6096829923375475E14 1.4057529135365664E14 1.3929711483421945E14 1.5115073227979638E14 1.927326264744418E14 0.0 1024 1024 ",
		"mpicbg.trakem2.transform.AffineModel2D",
		"0.9959954450689255 -0.006041800590995902 -0.004600000216459077 0.9565616548633219 6.2029274670578785 25.493407758452953"
	},
	{
		"scope 5, 594 bead sample 3",
		"lenscorrection.NonLinearTransform",
		"5 21 272.226021613887 -3.1463359951427763 -3.6417471285939333 250.3737175669892 26.983477001175423 -25.089610222581648 7.27025921318377 16.22017484093042 4.33366227071268 22.05108119249315 -55.76223733603664 81.81256002402519 -4.079368551493699 -16.44719223790517 -7.395766626969461 -3.3715211438612194 -1.461358975349313 -24.984266044123633 59.501815129458834 -84.93032826358878 2.9976643846561335 4.227118661087786 3.183638958647883 2.6205542697485047 1.7757753749358884 2.6658213998800164 0.7290786629030137 15.586205087227466 -24.816415257231114 31.959813220371785 -0.3958459411027686 -1.9133223299808368 -2.01974506784876 -0.0017124390286493707 0.19224261168916912 -1.8028493084408275 -1.06695307128256 -0.2515124675957756 0.067300924791728 -6.042726594307114 5.756056746388262 3.81930533025479 575.6070579645598 381.9287615582086 409454.42478153284 228780.53186295016 213856.87921357248 3.1878297407625383E8 1.6570912621503368E8 1.32058312859296E8 1.44133353980174E8 2.6164031994530383E11 1.3027321524046475E11 9.68919453567102E10 9.08987673570832E10 1.0828658344947032E11 2.2238799448367312E14 1.0751513483002903E14 7.667053841511567E13 6.727421620389054E13 6.922872449704471E13 8.722117742359678E13 100.0 279.5225895116551 260.74697905601454 306577.438534466 211074.67618543617 250106.7183938793 3.035482615501711E8 1.8983057070455825E8 1.846252724692567E8 2.2982938347650263E8 2.9376278095500946E11 1.743712498536707E11 1.572581912349039E11 1.6550757666092917E11 2.130462415295894E11 2.8269664960830744E14 1.6223880716970488E14 1.4006429655352939E14 1.384585698068479E14 1.5166974363735697E14 1.9953864490150522E14 0.0 1024 1024 ",
		"mpicbg.trakem2.transform.AffineModel2D",
		"0.9953962221393154 -0.005854022488299765 -0.004448594217311366 0.9568079712077336 6.155887940205535 24.775056247540668"
	},
	{
		"scope 5, 647 bead sample 3",
		"lenscorrection.NonLinearTransform",
		"5 21 270.2503618766115 -4.659941266930404 -3.9946052725390566 251.2680632999298 9.111280768542144 -16.777305997879974 8.161507147211822 16.485109208792977 6.188512387320689 22.700234461899964 15.914303346933853 64.75228790749959 -5.754853870620423 -16.517263698227644 -8.859464957120919 -3.651793711782748 -5.329291751718518 -26.404361895719674 -28.552758449988662 -69.71973094999743 4.448086347694625 4.013804312750102 4.031335229846129 2.7910763574030217 3.285605433459847 2.561822672597775 4.180235639404348 17.239374240346308 9.815285771761427 26.916125953665382 -0.9201228110995787 -1.7868187830064186 -2.0579726959054674 0.038081670317263505 -0.2516199078050858 -1.9237356212978538 -1.5761680399424578 -0.04908007717155849 -1.07290985545239 -6.767017424418473 5.7170398779517955 3.858245976202861 571.7046442395307 385.8228344941543 404196.9170736382 230113.92906854983 217424.02128168204 3.12826196621179E8 1.6633983726832214E8 1.3400836431840336E8 1.469975783008875E8 2.5527805523624988E11 1.3048333466146675E11 9.840448353182211E10 9.277102990632423E10 1.1065398732770714E11 2.1576213625922172E14 1.0739400115061228E14 7.787768956102588E13 6.886826488198681E13 7.096499683272952E13 8.927583686872417E13 100.0 278.1250756054607 261.85354654012804 303160.49012559786 213198.80978508934 251760.02477952413 2.985007414886826E8 1.9172219780736718E8 1.87389377861073E8 2.3203266771572042E8 2.874366587251048E11 1.754782869891184E11 1.599677449343956E11 1.687969415427184E11 2.155551673716017E11 2.7546164464890356E14 1.6249469443616972E14 1.4210281195949762E14 1.4169615681731112E14 1.5531951087512544E14 2.0215894971327028E14 0.0 1024 1024 ",
		"mpicbg.trakem2.transform.AffineModel2D",
		"0.995346078201126 -0.005857693508993017 -0.004430024083614124 0.955836140628525 6.210352784942632 25.187906105300563"
	}
};


ImageProcessor visualizeDifference(
		int w,
		int h,
		int pWidth,
		int pHeight,
		CoordinateTransform ct1,
		CoordinateTransform ct2) {
	double sx = (double)pWidth / w;
	double sy = (double)pHeight / h;
	FloatProcessor ip = new FloatProcessor(w, h);
	for (int y = 0; y < h; ++y) {
		for (int x = 0; x < w; ++x) {
			double[] l1 = new double[]{x * sx, y * sy};
			double[] l2 = new double[]{x * sx, y * sy};
			ct1.applyInPlace(l1);
			ct2.applyInPlace(l2);
			double dx = l1[0] - l2[0];
			double dy = l1[1] - l2[1];
			double d = Math.sqrt(dx * dx + dy * dy);
			ip.setf(x, y, (float)d);
		}
	}
	//matrix.copyBits( ip, i * 256, j * 256, Blitter.COPY );
	return ip;
}


ImageProcessor visualizeDifferenceVectorDistribution(
		int w,
		int h,
		int pWidth,
		int pHeight,
		CoordinateTransform ct1,
		CoordinateTransform ct2,
		double max) {
	double hw = 0.5 * w;
	double hh = 0.5 * h;
	double sx = (double)pWidth / w;
	double sy = (double)pHeight / h;
	FloatProcessor ip = new FloatProcessor(w, h);
	for (int y = 0; y < h; ++y) {
		for (int x = 0; x < w; ++x) {
			double[] l1 = new double[]{x * sx, y * sy};
			double[] l2 = new double[]{x * sx, y * sy};
			ct1.applyInPlace(l1);
			ct2.applyInPlace(l2);
			double dx = l1[0] - l2[0];
			double dy = l1[1] - l2[1];
			dx = Math.min(w - 1, Math.max(0.0, (dx / max + 1) * hw));
			dy = Math.min(w - 1, Math.max(0.0, (dy / max + 1) * hh));
			int ix = (int)Math.round(dx);
			int iy = (int)Math.round(dy);
			ip.setf(ix, iy, (float)(1.0 + ip.getPixelValue(ix, iy)));
		}
	}
	//matrix.copyBits( ip, i * 256, j * 256, Blitter.COPY );
	return ip;
}

ImageProcessor visualizeDifferenceVectors(
		int w,
		int h,
		int pWidth,
		int pHeight,
		CoordinateTransform ct1,
		CoordinateTransform ct2,
		double max) {
	double sx = (double)pWidth / w;
	double sy = (double)pHeight / h;
	ColorProcessor ip = new ColorProcessor(w, h);
	for (int y = 0; y < h; ++y) {
		for (int x = 0; x < w; ++x) {
			double[] l1 = new double[]{x * sx, y * sy};
			double[] l2 = new double[]{x * sx, y * sy};
			ct1.applyInPlace(l1);
			ct2.applyInPlace(l2);
			double dx = (l1[0] - l2[0] ) / max;
			double dy = (l1[1] - l2[1] ) / max;
			double d = Math.sqrt(dx * dx + dy * dy);
			double s = 1.0 / d;
			if (s < 1.0) {
				dx *= s;
				dy *= s;
			}
			
			ip.set(x, y, mpicbg.ij.util.Util.colorVector(dx, dy));
		}
	}
	return ip;
}

Model sampleModel(CoordinateTransform ct, Class modelClass, int width, int height) {
	model = modelClass.newInstance();
	matches = new ArrayList();
	double scaleX = ((double)width - 1.0f) / 63.0f;
	double scaleY = ((double)height - 1.0f) / 63.0f;
	for (int y = 0; y < 64; ++y) {
		double ys = scaleY * y;
		for (int x = 0; x < 64; ++x) {
			double xs = scaleX * x;
			Point p = new Point(new double[]{xs, ys});
			p.apply(ct);
			matches.add(new PointMatch(p, p));
		}
	}
	model.fit(matches);
	return model;
}

/**
 * Estimate a transformation model between two CoordinateTransforms.
 * The model maps ct1 into ct2.
 */
Model sampleModel2(
		CoordinateTransform ct1,
		CoordinateTransform ct2,
		Class modelClass,
		int width,
		int height) {
	model = modelClass.newInstance();
	matches = new ArrayList();
	double scaleX = ((double)width - 1.0f) / 63.0f;
	double scaleY = ((double)height - 1.0f) / 63.0f;
	for (int y = 0; y < 64; ++y) {
		double ys = scaleY * y;
		for (int x = 0; x < 64; ++x) {
			double xs = scaleX * x;
			Point p = new Point(new double[]{xs, ys});
			Point q = new Point(new double[]{xs, ys});
			ct1.applyInPlace(p.getL());
			q.apply(ct2);
			matches.add(new PointMatch(p, q));
		}
	}
	model.fit(matches);
	return model;
}


CoordinateTransform createTransform(
		String className,
		String dataString) {
	CoordinateTransform ct = (CoordinateTransform)Class.forName(className).newInstance();
	ct.init(dataString);
	return ct;
}

CoordinateTransformList createTransformList(int j) {
	CoordinateTransformList ctl = new CoordinateTransformList();
	for (int k = 2; k < transforms[j].length; k +=2)
		ctl.add(createTransform(transforms[j][k-1], transforms[j][k]));
	return ctl;
}

ImagePlus showDifferenceVectors() {
	ColorProcessor table = new ColorProcessor(
		(w + xSkip) * transforms.length - xSkip,
		(h + ySkip) * transforms.length - ySkip);
	ImagePlus impTable = new ImagePlus("Matrix", table);
	impTable.show();
	
	for (int i = 0; i < transforms.length; ++i) {
		ct1 = createTransformList(i);
		for (int j = 0; j < transforms.length; ++j) {
			ct2 = createTransformList(j);
	
			/* fit a simple linear model to compare with using some transferred samples */
			t = sampleModel2(ct2, ct1, invarianceModelClass, pWidth, pHeight);
			ct2.add(t);
	
			ImageProcessor ip = visualizeDifferenceVectors(
				w,
				h,
				pWidth,
				pHeight,
				ct1,
				ct2,
				max);
	
			table.copyBits(ip, (w + xSkip) * i, (h + ySkip) * j, Blitter.COPY);
			impTable.updateAndDraw();
		}
	}
	return impTable;
}


ImagePlus showDifferenceVectorDistributions() {
	FloatProcessor table = new FloatProcessor(
		(w + xSkip) * transforms.length - xSkip,
		(h + ySkip) * transforms.length - ySkip);
	ImagePlus impTable = new ImagePlus("Matrix", table);
	impTable.show();
	
	
	for (int i = 0; i < transforms.length; ++i) {
		ct1 = createTransformList(i);
		for (int j = 0; j < transforms.length; ++j) {
			ct2 = createTransformList(j);
	
			/* fit a simple linear model to compare with using some transferred samples */
			t = sampleModel2(ct2, ct1, invarianceModelClass, pWidth, pHeight);
			ct2.add(t);
	
			ImageProcessor ip = visualizeDifferenceVectorDistribution(
				w,
				h,
				pWidth,
				pHeight,
				ct1,
				ct2,
				max);
	
			table.copyBits(ip, (w + xSkip) * i, (h + ySkip) * j, Blitter.COPY);
			impTable.updateAndDraw();
		}
	}
	return impTable;
}

void drawCircles(ColorProcessor ip) {
	for (int s = 1; s <= max; ++s) {
		ip.setColor(
			new Color(
				(float)(Math.min(1.0f, 2.0f * s / max)),
				(float)(Math.min(1.0f, 2.0f - 2 * s / max)),
				0.0f));
		for (int i = 0; i < transforms.length; ++i) {
			int x = (w + xSkip) * i;
			for (int j = i + 1; j < transforms.length; ++j) {
				int y = (h + ySkip) * j;
				ip.drawOval(
					(int)(w / 2 + x - Math.round(s * w / max / 2)),
					(int)(h / 2 + y - Math.round(s * h / max / 2)),
					(int)Math.round(s * w / max) + 1,
					(int)Math.round(s * h / max) + 1);
			}
		}
	}
}

void drawLabels(ImagePlus imp, int offset) {
	ip = imp.getProcessor().createProcessor(imp.getWidth() + offset, imp.getHeight() +offset);
	ip.copyBits(imp.getProcessor(), offset, offset, Blitter.COPY);
	ip.setColor(Color.WHITE);
	ip.setAntialiasedText(true);
	ip.setJustification(ImageProcessor.CENTER_JUSTIFY);
	Font font = new Font(Font.SANS_SERIF, Font.PLAIN, 14);
	ip.setFont(font);
	for (int i = 0; i < transforms.length; ++i) {
		int x = (w + xSkip) * i;
		ip.drawString(
			transforms[i][0],
			(int)(w / 2 + x + offset),
			20);
	}
	ip = ip.rotateRight();
//	ip.flipHorizontal();
	ip.setColor(Color.WHITE);
	ip.setAntialiasedText(true);
	ip.setJustification(ImageProcessor.CENTER_JUSTIFY);
	//ip.setFont(font.deriveFont(new AffineTransform(-1, 0, 0, 1, 0, 0)));
	ip.setFont(font);
	for (int i = 0; i < transforms.length; ++i) {
		int x = (w + xSkip) * i;
		ip.drawString(
			transforms[transforms.length - 1 - i][0],
			(int)(w / 2 + x),
			20);
	}
	ip = ip.rotateLeft();
//	ip.flipHorizontal();
	imp.setProcessor(ip);
}


// main

impVectors = showDifferenceVectors();
impDists = showDifferenceVectorDistributions();

impDists.setDisplayRange(0, 32);
Thread.sleep(1000);
IJ.run(impDists, "Fire", "");
Thread.sleep(1000);
IJ.run(impDists, "RGB Color", "");
Thread.sleep(1000);
impDists.getProcessor().snapshot();
roi = new PolygonRoi(
	new int[]{0, impVectors.getWidth(), impVectors.getWidth()},
	new int[]{0, 0, impVectors.getHeight()},
	3,
    Roi.POLYGON);
impVectors.setRoi(roi);
IJ.run(impVectors, "Copy", "");
impDists.setRoi(roi);
IJ.run(impDists, "Paste", "");

drawCircles(impDists.getProcessor());
drawLabels(impDists, 26);
impDists.updateAndDraw();
